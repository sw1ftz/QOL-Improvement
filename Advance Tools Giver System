local replicatedStorage = game:GetService("ReplicatedStorage").Tools
local settings = require(script.Parent:FindFirstChild("Setting")) -- Load configuration from Setting module

-- Global usage count for Slap
local globalSlapUses = 0

-- Function to check if player has the tool
local function hasTool(player, toolName)
	local backpack = player:FindFirstChild("Backpack")
	local character = player.Character
	return (backpack and backpack:FindFirstChild(toolName)) or (character and character:FindFirstChild(toolName))
end

-- Function to remove a tool from the player's backpack and character
local function removeTool(player, toolName)
	for _, container in ipairs({player:FindFirstChild("Backpack"), player.Character}) do
		if container then
			local tool = container:FindFirstChild(toolName)
			if tool then
				tool:Destroy()
			end
		end
	end
end

-- Function to toggle multiple mesh parts
local function toggleMeshParts(parts, transparency, canCollide)
	for _, partName in ipairs(parts) do
		local part = script.Parent.Parent:FindFirstChild(partName)
		if part then
			part.Transparency = transparency
			part.CanCollide = canCollide
		end
	end
end

-- Function to show notifications (Placeholder, implement UI as needed)
local function showNotification(player, message)
	print("Notification to " .. player.Name .. ": " .. message)
end

-- Function to find tool in ReplicatedStorage
local function findToolInReplicatedStorage(toolName)
	local tool = replicatedStorage:FindFirstChild(toolName)
	if not tool then
		warn("[ERROR] Tool '" .. toolName .. "' not found in ReplicatedStorage!")
	end
	return tool
end

-- Function to give a tool and toggle mesh visibility
local function giveToolAndToggleMesh(player, toolData)
	local character = player.Character
	local backpack = player:FindFirstChild("Backpack")
	if not character or not backpack then return end

	local tool = findToolInReplicatedStorage(toolData.toolName)
	if not tool then return end

	if toolData.toolName == settings.SlapToolName then
		if globalSlapUses >= settings.MaxSlapUses then
			warn(settings.SlapToolName .. " has reached its global limit!")
			return
		end
		globalSlapUses = globalSlapUses + 1
		if globalSlapUses >= settings.MaxSlapUses then
			toggleMeshParts(toolData.meshParts, 1, false)
			local slapClickPart = script.Parent.Parent:FindFirstChild(toolData.clickDetectorPart)
			if slapClickPart then
				local clickDetector = slapClickPart:FindFirstChild("ClickDetector")
				if clickDetector then
					clickDetector:Destroy()
				end
			end
		end
	end

	local hasTakenM870 = player:FindFirstChild("HasTakenM870")
	if toolData.toolName == settings.HiddenToolName then
		if hasTool(player, toolData.toolName) then
			removeTool(player, toolData.toolName)
			toggleMeshParts(toolData.meshParts, 0, true)
			if hasTakenM870 then
				hasTakenM870.Value = false
			end
			showNotification(player, "You have returned the M870 tool.")
		else
			if hasTakenM870 and hasTakenM870.Value then
				warn("Player does not have the M870 tool to put back!")
				showNotification(player, "You do not have the M870 tool to put back!")
			else
				local toolClone = tool:Clone()
				toolClone.Parent = backpack
				toggleMeshParts(toolData.meshParts, 1, false)
				if not hasTakenM870 then
					hasTakenM870 = Instance.new("BoolValue")
					hasTakenM870.Name = "HasTakenM870"
					hasTakenM870.Value = true
					hasTakenM870.Parent = player
				else
					hasTakenM870.Value = true
				end
				showNotification(player, "You have received the M870 tool.")
			end
		end
		return
	end

	if hasTool(player, toolData.toolName) then
		return
	end

	local toolClone = tool:Clone()
	toolClone.Parent = backpack
	if toolData.toolName == settings.HiddenToolName then
		toggleMeshParts(toolData.meshParts, 1, false)
	end
	showNotification(player, "You have received the " .. toolData.toolName .. " tool.")
end

-- Function to setup click detection
local function setupClickDetection(partName, toolData)
	local clickPart = script.Parent.Parent:FindFirstChild(partName)
	if not clickPart then
		warn(partName .. " not found!")
		return
	end

	local clickDetector = clickPart:FindFirstChild("ClickDetector")
	if not clickDetector then
		warn("ClickDetector not found inside " .. partName .. "!")
		return
	end

	clickDetector.MouseClick:Connect(function(player)
		giveToolAndToggleMesh(player, toolData)
	end)
end

-- Setup click detection for tools using settings module
for partName, toolData in pairs(settings.ToolMapping) do
	setupClickDetection(partName, toolData)
end
